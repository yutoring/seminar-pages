<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ã‚»ãƒŸãƒŠãƒ¼ä¸€è¦§</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      /* Lighter, more pastel aurora gradient for better contrast */
      background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
      margin: 0;
      padding: 0;
      color: #333;
      min-height: 100vh;
    }

    @keyframes gradient {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* Header Section (Liquid Glass) */
    header {
      background: rgba(255, 255, 255, 0.6);
      /* Increased opacity for legibility */
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      padding: 16px 20px;
      text-align: center;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 16px;
      color: #333;
      /* Dark text for contrast against light glass */
      font-weight: 700;
      letter-spacing: 0.05em;
      white-space: nowrap;
      /* Remove strong shadow on text */
    }

    /* PCM Dots */
    .pcm-dots {
      display: flex;
      gap: 4px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .Thinker {
      background-color: #1a73e8;
    }

    .Persister {
      background-color: #9c27b0;
    }

    .Promoter {
      background-color: #f44336;
    }

    .Harmonizer {
      background-color: #ff9800;
    }

    .Imaginer {
      background-color: #795548;
    }

    .Rebel {
      background-color: #fdd835;
    }

    /* Container */
    #app {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 16px 40px 16px;
    }

    #debug {
      background: rgba(0, 0, 0, 0.85);
      color: #0f0;
      font-size: 11px;
      padding: 10px;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 180px;
      overflow-y: scroll;
      z-index: 9999;
      display: none;
    }

    /* Card Design (Liquid Glass - High Contrast) */
    .card {
      background: rgba(255, 255, 255, 0.75);
      /* Much whiter background for readability */
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s;
      position: relative;
      overflow: hidden;
      color: #2c3e50;
    }

    /* Specular Highlight - Subtle */
    .card::before {
      content: "";
      position: absolute;
      top: 0;
      left: -50%;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom right,
          rgba(255, 255, 255, 0.9) 0%,
          rgba(255, 255, 255, 0) 40%);
      transform: skewX(-20deg);
      pointer-events: none;
      opacity: 0.3;
    }

    /* VIP UI for Re-attendance (Gira-gira Black & Gold) */
    .vip-card {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      border: 2px solid #e94560;
      box-shadow: 0 10px 40px rgba(233, 69, 96, 0.4), inset 0 0 20px rgba(233, 69, 96, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
      color: #fff;
      text-align: center;
      animation: pulse-border-vip 2s infinite;
    }

    /* Gold/Neon shimmer effect */
    .vip-card::after {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 215, 0, 0.1) 50%, rgba(255, 255, 255, 0) 100%);
      transform: rotate(30deg);
      animation: shimmer 3s infinite linear;
      pointer-events: none;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%) rotate(30deg);
      }

      100% {
        transform: translateX(100%) rotate(30deg);
      }
    }

    @keyframes pulse-border-vip {
      0% {
        box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.6), inset 0 0 20px rgba(233, 69, 96, 0.2);
      }

      70% {
        box-shadow: 0 0 0 15px rgba(233, 69, 96, 0), inset 0 0 30px rgba(233, 69, 96, 0.4);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(233, 69, 96, 0), inset 0 0 20px rgba(233, 69, 96, 0.2);
      }
    }

    .vip-label {
      display: inline-block;
      background: linear-gradient(90deg, #ffd700, #ff8c00);
      color: #000;
      font-size: 13px;
      font-weight: 900;
      padding: 6px 16px;
      border-radius: 20px;
      margin-bottom: 16px;
      letter-spacing: 0.1em;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
      box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4);
      position: relative;
      z-index: 2;
    }

    .vip-card h2 {
      font-size: 24px;
      color: #fff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px #e94560;
      margin: 0 0 12px 0;
      line-height: 1.3;
      position: relative;
      z-index: 2;
    }

    .vip-card p {
      font-size: 13.5px;
      color: #e0e0e0;
      margin: 0 0 24px 0;
      line-height: 1.5;
      position: relative;
      z-index: 2;
    }

    .vip-info-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 8px 0;
      font-size: 13.5px;
      color: #fff;
      margin-bottom: 20px;
      text-align: left;
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 2;
    }

    .vip-info-label {
      font-weight: bold;
      color: #ffd700;
    }

    .btn-vip {
      display: block;
      width: 100%;
      text-align: center;
      background: linear-gradient(135deg, #e94560 0%, #a20a2e 100%);
      color: white;
      padding: 16px 0;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 800;
      border: 2px solid #ff7b93;
      font-size: 17px;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(233, 69, 96, 0.6), inset 0 0 10px rgba(255, 255, 255, 0.3);
      transition: all 0.2s ease;
      position: relative;
      z-index: 2;
      letter-spacing: 0.05em;
    }

    .btn-vip:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 10px 30px rgba(233, 69, 96, 0.8), inset 0 0 15px rgba(255, 255, 255, 0.5);
      background: linear-gradient(135deg, #ff5c77 0%, #c4123c 100%);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
      background: rgba(255, 255, 255, 0.85);
      /* Almost opaque on hover */
      border-color: rgba(255, 255, 255, 0.9);
    }

    .card:active {
      transform: scale(0.98);
    }

    /* Status Badge */
    .status-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 0.05em;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      z-index: 2;
    }

    .status-open {
      color: #2e7d32;
      border: 1px solid #c8e6c9;
      background: #e8f5e9;
    }

    .status-full {
      color: #c62828;
      border: 1px solid #ffcdd2;
      background: #ffebee;
    }

    .status-wait {
      color: #616161;
      border: 1px solid #e0e0e0;
      background: #f5f5f5;
    }

    /* Typography */
    .date {
      color: #1976d2;
      /* Strong blue */
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }

    .date::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #1976d2;
      border-radius: 50%;
      margin-right: 8px;
    }

    .card h2 {
      font-size: 19px;
      margin: 0 0 16px 0;
      color: #111;
      /* Almost black for title */
      line-height: 1.4;
      position: relative;
      z-index: 1;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 6px 12px;
      font-size: 13.5px;
      color: #333;
      margin-bottom: 14px;
      position: relative;
      z-index: 1;
    }

    .info-label {
      font-weight: bold;
      color: #555;
      white-space: nowrap;
    }

    .comment-box {
      background: rgba(255, 255, 255, 0.6);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      color: #444;
      margin-bottom: 14px;
      line-height: 1.5;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Deadline Tags */
    .deadline-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 14px;
      position: relative;
      z-index: 1;
    }

    .deadline-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 11.5px;
      color: #555;
    }

    .deadline-tag .dl-label {
      font-weight: 600;
      color: #888;
    }

    .deadline-tag .dl-date {
      color: #333;
      font-weight: 500;
    }

    /* Registration Section */
    .reg-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .reg-section .section-title {
      text-align: center;
      font-size: 13px;
      color: #888;
      margin-bottom: 16px;
    }

    .reg-card {
      background: rgba(255, 255, 255, 0.75);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .reg-card h3 {
      margin: 0 0 8px;
      font-size: 15px;
      color: #333;
    }

    .reg-card p {
      margin: 0 0 16px;
      font-size: 12.5px;
      color: #666;
      line-height: 1.6;
    }

    .btn-reg {
      display: inline-block;
      width: 100%;
      padding: 12px;
      background: #666;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }

    /* Price Section */
    .price-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 16px;
      position: relative;
      z-index: 1;
    }

    .price-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 11px;
      color: #666;
    }

    .price-item:first-child {
      align-items: flex-start;
    }

    .price-item:last-child {
      align-items: flex-end;
    }

    .price-val {
      font-size: 14px;
      font-weight: bold;
      color: #222;
      margin-top: 2px;
    }

    /* Button */
    .btn {
      display: block;
      width: 100%;
      text-align: center;
      background: linear-gradient(135deg, #06c755 0%, #05b34c 100%);
      color: white;
      padding: 14px 0;
      border-radius: 50px;
      text-decoration: none;
      font-weight: bold;
      border: none;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      z-index: 1;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(6, 199, 85, 0.3);
    }

    .btn.disabled {
      background: #e0e0e0;
      color: #9e9e9e;
      cursor: not-allowed;
      box-shadow: none;
    }

    .loading {
      text-align: center;
      margin-top: 50px;
    }
  </style>
</head>

<body>

  <header>
    <div class="pcm-dots">
      <span class="dot Thinker"></span>
      <span class="dot Persister"></span>
      <span style="font-size: 14px; line-height: 10px;">â¤ï¸</span>
    </div>
    <h1>æ­¦å²¡ä¼¸å¹¸PCMã‚»ãƒŸãƒŠãƒ¼</h1>
    <div class="pcm-dots">
      <span class="dot Harmonizer"></span>
      <span class="dot Imaginer"></span>
      <span class="dot Rebel"></span>
    </div>
  </header>

  <div id="app">
    <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
  <div id="debug">Debug Log:</div>

  <script>
    // ==========================================
    // Constants
    // ==========================================
    const LIFF_ID = '2009026233-a9Vi8lsj';
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyUjqY83pRshVoWoRJsCTWG8S1oiFLqzxqRZ69NoADNqkl1qnkf8iYyqT80OKskWA0IwA/exec';
    const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdvMlF-nnf3qgebUwI4JrcnKddfQgyww16uT2qmM9MxgOb4sg/viewform';
    // ==========================================

    const ENTRY_SEMINAR = 'entry.100643207'; // SeminarID
    const ENTRY_USER = 'entry.1734163930'; // UserID

    // äº‹å‰å…¥åŠ›ç”¨ Google Form Entry IDs
    // â€» Question IDã§ã¯ãªãEntry IDï¼ˆdata-paramsã®å†…å´ã®IDï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨
    const ENTRY_COMPANY = 'entry.512004671'; // å¾¡ç¤¾åï¼ˆå›£ä½“åï¼‰â€»ä»»æ„
    const ENTRY_LAST_NAME = 'entry.1228820142'; // è‹—å­—
    const ENTRY_FIRST_NAME = 'entry.1311373621'; // åå‰
    const ENTRY_LAST_NAME_EN = 'entry.1991006458'; // è‹—å­—ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼‰
    const ENTRY_FIRST_NAME_EN = 'entry.884066588'; // åå‰ ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼‰
    const ENTRY_SEX = 'entry.1440227199'; // æ€§åˆ¥
    // const ENTRY_BIRTH = 'entry.775334417'; // ç”Ÿå¹´æœˆæ—¥ (æ—¥ä»˜è¦ç´ ãªã®ã§åˆ†è§£ãŒå¿…è¦ãªå ´åˆã‚ã‚Š)
    const ENTRY_ZIP = 'entry.1107386333'; // éƒµä¾¿ç•ªå·
    const ENTRY_PREF = 'entry.16340754'; // éƒ½é“åºœçœŒ
    const ENTRY_CITY = 'entry.20812020'; // å¸‚åŒºç”ºæ‘
    const ENTRY_ADDR1 = 'entry.517546570'; // ç•ªåœ°
    const ENTRY_ADDR2 = 'entry.1191090335'; // å»ºç‰©å
    const ENTRY_PHONE = 'entry.1066659949'; // é€£çµ¡å…ˆé›»è©±

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯è¨­å®šã§ã€Œå…¥åŠ›ã‚’æ±‚ã‚ã‚‹ã€ã¨ãªã£ã¦ã„ã‚‹å°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãŸã‚ entry.XXX ã§ã¯ã‚ã‚Šã¾ã›ã‚“
    const ENTRY_EMAIL = 'emailAddress';

    // Check URL parameter for ?debug=true
    const urlParams = new URLSearchParams(window.location.search);
    const IS_DEBUG = urlParams.get('debug') === 'true';

    if (IS_DEBUG) {
      document.getElementById('debug').style.display = 'block';
    }

    function log(msg) {
      console.log(msg);
      if (IS_DEBUG) {
        const d = document.getElementById('debug');
        if (d) d.innerHTML += '\n[' + new Date().toLocaleTimeString() + '] ' + msg;
      }
    }

    function withTimeout(promise, ms) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error('TIMEOUT after ' + ms + 'ms')), ms))
      ]);
    }

    // ==========================================
    // Main
    // ==========================================
    async function main() {
      try {
        log('=== main start ===');
        log('URL: ' + window.location.href);
        log('Origin: ' + window.location.origin);
        log('LIFF ID: ' + LIFF_ID);

        // 1. LIFF åˆæœŸåŒ–
        log('Calling liff.init...');
        await withTimeout(liff.init({ liffId: LIFF_ID }), 10000);
        log('liff.init SUCCESS');

        log('isLoggedIn: ' + liff.isLoggedIn());
        log('isInClient: ' + liff.isInClient());
        log('OS: ' + liff.getOS());

        // 2. ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        if (!liff.isLoggedIn()) {
          log('Not logged in');
          document.getElementById('app').innerHTML =
            '<div style="text-align:center; padding:20px;">' +
            '<p>LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>' +
            '<button class="btn" onclick="liff.login()">LINEã§ãƒ­ã‚°ã‚¤ãƒ³</button>' +
            '</div>';
          return;
        }

        // 3. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
        const profile = await liff.getProfile();
        const userId = profile.userId;
        log('UserID: ' + userId);
        log('Name: ' + profile.displayName);

        // 4. ã‚»ãƒŸãƒŠãƒ¼ä¸€è¦§å–å¾—
        loadSeminars(userId);

      } catch (err) {
        log('ERROR: ' + err.message);
        if (err.message.includes('TIMEOUT')) {
          document.getElementById('app').innerHTML =
            '<p>LIFFåˆæœŸåŒ–ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚</p>' +
            '<p style="font-size:12px;color:#999;">LINEã‚¢ãƒ—ãƒªå†…ã§é–‹ã„ã¦ãã ã•ã„ã€‚</p>';
        } else {
          document.getElementById('app').innerHTML = '<p>ã‚¨ãƒ©ãƒ¼: ' + err.message + '</p>';
        }
      }
    }

    // ==========================================
    // APIå‘¼ã³å‡ºã— (Fetch)
    // ==========================================
    async function loadSeminars(userId) {
      log('Fetching seminars and user profile...');
      try {
        const [resSeminars, resProfile] = await Promise.all([
          fetch(GAS_API_URL + '?action=getSeminars'),
          fetch(GAS_API_URL + '?action=getUserProfileForReattendance&userId=' + encodeURIComponent(userId))
        ]);

        log('HTTP Status: S=' + resSeminars.status + ' P=' + resProfile.status);

        const seminars = await resSeminars.json();
        const profileData = await resProfile.json();

        log('Seminars loaded: ' + seminars.length);
        log('Is Customer: ' + profileData.isCustomer);

        renderList(seminars, userId, profileData);

      } catch (err) {
        log('Fetch Error: ' + err.message);
        document.getElementById('app').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: ' + err.message + '</p>';
      }
    }

    // ==========================================
    // Render (å¤‰æ›´ãªã—)
    // ==========================================
    function esc(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function renderList(seminars, userId, profileData) {
      const app = document.getElementById('app');
      let html = '';

      // --- 1. VIP BLOCK (éå»å—è¬›è€…ã®ã¿) ---
      if (profileData && profileData.isCustomer && profileData.nearestSeminar) {
        const s = profileData.nearestSeminar;
        html += `
            <div class="vip-card">
               <div class="vip-label">æ±å¤§é˜ªPCMéå»å—è¬›è€… é™å®š</div>
               <h2>ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—å†å—è¬›</h2>
               <p>éå»ã®å—è¬›è¨˜éŒ²ã‹ã‚‰ã€ç›´è¿‘ã®ã‚»ãƒŸãƒŠãƒ¼ã«å³åº§ã«äºˆç´„ã‚’ç¢ºå®šã—ã¾ã™ã€‚<br><span style="color: #ffd700; font-size: 11.5px; opacity: 0.9;">â€»ã“ã¡ã‚‰ã¯ã€Œæ‡‡è¦ªä¼šã¤ãã€ã®å°‚ç”¨ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç”³è¾¼æ ã§ã™ã€‚</span></p>
               
               <div class="info-grid" style="text-align: left; background: rgba(0,0,0,0.5); padding: 14px; border-radius: 8px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 2; color: #fff;">
                 <div class="info-label" style="color: #aaa;">å¯¾è±¡æ—¥ç¨‹</div>
                 <div style="font-weight: bold; color: #ff9a9e; font-size: 15px;">${esc(s.date)} ${esc(s.time)}</div>
                 <div class="info-label" style="color: #aaa;">å ´æ‰€</div>
                 <div>${esc(s.venue)}</div>
                 <div class="info-label" style="color: #aaa;">ãƒ—ãƒ©ãƒ³</div>
                 <div>å†å—è¬› ï¼‹ æ‡‡è¦ªä¼š</div>
                 <div class="info-label" style="color: #aaa;">åˆè¨ˆé‡‘é¡</div>
                 <div style="font-weight: 900; color: #ffd700; font-size: 17px; text-shadow: 0 0 5px rgba(255,215,0,0.5);">Â¥${Number((s.fee_repeat || 0) + (s.fee_party || 0)).toLocaleString()}</div>
               </div>

               <button class="btn-vip" onclick="doDirectBooking('${esc(userId)}', '${esc(s.pid)}')">
                  ğŸ”¥ ${esc(s.date.replace(/^[0-9]+å¹´/, ''))} æ‡‡è¦ªä¼šã¤ãã§å†å—è¬›ã™ã‚‹
               </button>
            </div>
            
            <hr style="border: 0; height: 1px; background: rgba(0,0,0,0.1); margin: 30px 0;">
            <div style="text-align:center; color: #666; font-size: 13px; margin-bottom: 20px;">ãã®ä»–ã®æ—¥ç¨‹ãƒ»ã€Œæ‡‡è¦ªä¼šãªã—ã€ã‚’ã”å¸Œæœ›ã®æ–¹ã¯ã“ã¡ã‚‰</div>
          `;
      }

      // --- 2. Normal Seminar List ---
      // åç°¿ç™»éŒ²ç”¨ã‚»ãƒŸãƒŠãƒ¼ã‚’åˆ†é›¢
      const regSeminars = seminars ? seminars.filter(s => s.name.includes('åç°¿ç™»éŒ²')) : [];
      const normalSeminars = seminars ? seminars.filter(s => !s.name.includes('åç°¿ç™»éŒ²')) : [];

      if (normalSeminars.length === 0 && regSeminars.length === 0) {
        html += '<p style="text-align:center;">ç¾åœ¨å‹Ÿé›†ä¸­ã®ã‚»ãƒŸãƒŠãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        app.innerHTML = html;
        return;
      }

      normalSeminars.forEach(s => {
        let applyUrl = FORM_BASE_URL +
          '?' + ENTRY_SEMINAR + '=' + encodeURIComponent(s.pid) +
          '&' + ENTRY_USER + '=' + encodeURIComponent(userId);

        // äº‹å‰å…¥åŠ›URLã®ç”Ÿæˆï¼ˆé¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
        if (profileData && profileData.isCustomer && profileData.profile) {
          const p = profileData.profile;
          const addParam = (key, val) => {
            if (val) applyUrl += '&' + key + '=' + encodeURIComponent(val);
          };
          addParam(ENTRY_EMAIL, p['ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹']);
          addParam(ENTRY_COMPANY, p['å¾¡ç¤¾åï¼ˆå›£ä½“åï¼‰â€»ä»»æ„']);
          addParam(ENTRY_LAST_NAME, p['è‹—å­—']);
          addParam(ENTRY_FIRST_NAME, p['åå‰']);
          addParam(ENTRY_LAST_NAME_EN, p['è‹—å­—ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼‰']);
          addParam(ENTRY_FIRST_NAME_EN, p['åå‰ ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼‰']);
          addParam(ENTRY_SEX, p['æ€§åˆ¥']);
          addParam(ENTRY_ZIP, p['éƒµä¾¿ç•ªå·']);
          addParam(ENTRY_PREF, p['éƒ½é“åºœçœŒ']);
          addParam(ENTRY_CITY, p['å¸‚åŒºç”ºæ‘']);
          addParam(ENTRY_ADDR1, p['ç•ªåœ°']);
          addParam(ENTRY_ADDR2, p['å»ºç‰©å']);
          addParam(ENTRY_PHONE, p['é€£çµ¡å…ˆé›»è©±']);
        }

        // Status Badge Logic
        let badgeClass = 'status-wait';
        if (s.status === 'å‹Ÿé›†ä¸­') badgeClass = 'status-open';
        if (s.status === 'æº€å¸­') badgeClass = 'status-full';

        // Button Logic
        let btnHtml = '';
        if (s.status === 'å‹Ÿé›†ä¸­') {
          const btnLabel = s.is_repeat_only ? 'å†å—è¬›ã‚’ç”³ã—è¾¼ã‚€' : 'ç”³ã—è¾¼ã‚€';
          btnHtml = `<button class="btn" onclick="window.location.href='${applyUrl}'">${btnLabel}</button>`;
        } else if (s.status === 'æº€å¸­') {
          btnHtml = `<button class="btn disabled" disabled>æº€å¸­</button>`;
        } else if (s.status === 'ç”³è¾¼å‰') {
          btnHtml = `<button class="btn disabled" disabled>ç”³è¾¼é–‹å§‹å‰</button>`;
        }

        const fmtDeadline = (d) => {
          if (!d || d === '-') return '';
          return d.replace(/^\d{4}[\/-]/, '').replace(/[\/-]/g, '/');
        };

        html += `
            <div class="card">
              <div class="status-badge ${badgeClass}">${esc(s.status)}</div>
              <div class="date">${esc(s.date)}</div>
              <h2>${esc(s.name)}</h2>
              
              <div class="info-grid">
                <div class="info-label">å ´æ‰€</div>
                <div>${esc(s.venue)}</div>
                <div class="info-label">æ™‚é–“</div>
                <div>${esc(s.time)}</div>
              </div>

              ${s.comment ? `<div class="comment-box">ğŸ’¡ ${esc(s.comment)}</div>` : ''}

              <div class="deadline-row">
                ${s.payment_deadline ? `<div class="deadline-tag"><span class="dl-label">åˆå—è¬›ç”³è¾¼&æŒ¯è¾¼æœŸé™</span><span class="dl-date">${esc(fmtDeadline(s.payment_deadline))}</span></div>` : ''}
                ${s.ppi_deadline ? `<div class="deadline-tag"><span class="dl-label">è³ªå•ç¥¨å›ç­”æœŸé™</span><span class="dl-date">${esc(fmtDeadline(s.ppi_deadline))}</span></div>` : ''}
                ${s.application_deadline ? `<div class="deadline-tag"><span class="dl-label">å†å—è¬›ç”³è¾¼æœŸé™</span><span class="dl-date">${esc(fmtDeadline(s.application_deadline))}</span></div>` : ''}
              </div>
              
              <div class="price-row">
                 <div class="price-item">
                   <span>åˆå—è¬›</span>
                   <span class="price-val">Â¥${Number(s.fee_new).toLocaleString()}</span>
                 </div>
                 <div class="price-item">
                   <span>å†å—è¬›</span>
                   <span class="price-val">Â¥${Number(s.fee_repeat).toLocaleString()}</span>
                 </div>
                 <div class="price-item">
                   <span>æ‡‡è¦ªä¼š</span>
                   <span class="price-val">Â¥${Number(s.fee_party || 0).toLocaleString()}</span>
                 </div>
              </div>

              ${btnHtml}
            </div>
          `;
      });

      // --- 3. Registration Section (åç°¿ç™»éŒ²) ---
      regSeminars.forEach(s => {
        let regUrl = FORM_BASE_URL +
          '?' + ENTRY_SEMINAR + '=' + encodeURIComponent(s.pid) +
          '&' + ENTRY_USER + '=' + encodeURIComponent(userId);

        if (profileData && profileData.isCustomer && profileData.profile) {
          const p = profileData.profile;
          const addParam = (key, val) => {
            if (val) regUrl += '&' + key + '=' + encodeURIComponent(val);
          };
          addParam(ENTRY_EMAIL, p['ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹']);
          addParam(ENTRY_COMPANY, p['å¾¡ç¤¾åï¼ˆå›£ä½“åï¼‰â€»ä»»æ„']);
          addParam(ENTRY_LAST_NAME, p['è‹—å­—']);
          addParam(ENTRY_FIRST_NAME, p['åå‰']);
          addParam(ENTRY_LAST_NAME_EN, p['è‹—å­—ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼‰']);
          addParam(ENTRY_FIRST_NAME_EN, p['åå‰ ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼‰']);
          addParam(ENTRY_SEX, p['æ€§åˆ¥']);
          addParam(ENTRY_ZIP, p['éƒµä¾¿ç•ªå·']);
          addParam(ENTRY_PREF, p['éƒ½é“åºœçœŒ']);
          addParam(ENTRY_CITY, p['å¸‚åŒºç”ºæ‘']);
          addParam(ENTRY_ADDR1, p['ç•ªåœ°']);
          addParam(ENTRY_ADDR2, p['å»ºç‰©å']);
          addParam(ENTRY_PHONE, p['é€£çµ¡å…ˆé›»è©±']);
        }

        html += `
          <div class="reg-section">
            <div class="section-title">éå»ã«å—è¬›ã•ã‚ŒãŸæ–¹ã¸</div>
            <div class="reg-card">
              <h3>åç°¿ç™»éŒ²</h3>
              <p>ä»Šå¾Œã®ã‚»ãƒŸãƒŠãƒ¼æƒ…å ±ã‚’LINEã§ãŠå±Šã‘ã™ã‚‹ãŸã‚ã®ç™»éŒ²ã§ã™ã€‚<br>å—è¬›ç”³è¾¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ãŠæ°—è»½ã«ã©ã†ãã€‚</p>
              <button class="btn-reg" onclick="window.location.href='${regUrl}'">åç°¿ç™»éŒ²ã™ã‚‹</button>
            </div>
          </div>
        `;
      });

      app.innerHTML = html;
    }

    // ==========================================
    // ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”³è¾¼æ©Ÿèƒ½ (VIPãƒœã‚¿ãƒ³ç”¨)
    // ==========================================
    async function doDirectBooking(userId, seminarId) {
      if (!confirm('ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç›´è¿‘ã‚»ãƒŸãƒŠãƒ¼ï¼ˆæ‡‡è¦ªä¼šä»˜ãï¼‰ã®äºˆç´„ã‚’ç¢ºå®šã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
      }

      const app = document.getElementById('app');
      // ç¾åœ¨ã®HTMLã‚’ä¿æŒã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å‡ºã™æ–¹ãŒç¶ºéº—ã§ã™ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ç½®æ›
      app.innerHTML = '<div class="loading">äºˆç´„å‡¦ç†ä¸­...ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</div>';

      try {
        const res = await fetch(GAS_API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'directBooking',
            userId: userId,
            seminarId: seminarId
          })
        });

        const data = await res.json();
        if (data.status === 'success') {
          app.innerHTML = `
                    <div style="text-align:center; padding: 40px 20px;">
                        <h2 style="color: #2e7d32;">ğŸ‰ äºˆç´„å®Œäº†ï¼</h2>
                        <p style="font-weight: bold; margin-bottom: 20px;">VIPãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
                        <p style="font-size: 14px; color: #555;">ã‚·ã‚¹ãƒ†ãƒ ã«ã¦å—ä»˜å‡¦ç†ã‚’è¡Œã„ã¾ã—ãŸã€‚<br>è©³ç´°ã‚„ã”æ¡ˆå†…ã¯LINEã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã«ã¦ãŠé€ã‚Šã„ãŸã—ã¾ã™ã€‚</p>
                        <br><br>
                        <button class="btn" onclick="liff.closeWindow()">ç”»é¢ã‚’é–‰ã˜ã‚‹</button>
                    </div>
                `;
        } else {
          throw new Error(data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      } catch (e) {
        log('Booking Error: ' + e.message);
        app.innerHTML = `
                <div style="text-align:center; padding: 40px 20px;">
                    <h2 style="color: #c62828;">âš ï¸ ã‚¨ãƒ©ãƒ¼</h2>
                    <p>äºˆç´„å‡¦ç†ä¸­ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
                    <p style="font-size:12px;color:#666; margin-bottom: 20px;">${e.message}</p>
                    <button class="btn" onclick="location.reload()">å†èª­ã¿è¾¼ã¿ã—ã¦ã‚„ã‚Šç›´ã™</button>
                </div>
            `;
      }
    }

    // Start
    main();
  </script>
</body>

</html>
